name: Contract Validation

on:
  push:
    branches: [main]
    paths:
      - 'specs/**/contracts/**'
      - 'frontend/src/services/**'
      - 'backend/src/main/java/**/api/**'
      - 'backend/src/main/java/**/dto/**'
  pull_request:
    branches: [main]
    paths:
      - 'specs/**/contracts/**'
      - 'frontend/src/services/**'
      - 'backend/src/main/java/**/api/**'
      - 'backend/src/main/java/**/dto/**'
  workflow_dispatch:

env:
  OPENAPI_SPEC: specs/001-product-list/contracts/openapi.yaml

jobs:
  validate-openapi:
    name: Validate OpenAPI Contract (SpecIT)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install validation tools
        run: |
          npm install -g @redocly/cli @stoplight/spectral-cli

      - name: Spectral Lint (SpecIT Rules)
        run: |
          echo "üîç Running Spectral linting with SpecIT rules..."
          spectral lint ${{ env.OPENAPI_SPEC }} --format=github-actions --fail-severity=error
          echo "‚úÖ Spectral validation passed"

      - name: Redocly Validate
        run: |
          echo "üîç Running Redocly validation..."
          redocly lint ${{ env.OPENAPI_SPEC }} --format=github-actions
          echo "‚úÖ Redocly validation passed"

      - name: Check for breaking changes (on PR)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}
          if git show origin/${{ github.base_ref }}:${{ env.OPENAPI_SPEC }} > /tmp/base-openapi.yaml 2>/dev/null; then
            echo "üîç Checking for breaking changes..."
            npx oasdiff breaking /tmp/base-openapi.yaml ${{ env.OPENAPI_SPEC }} --fail-on ERR
            echo "‚úÖ No breaking changes detected"
          else
            echo "‚ÑπÔ∏è No previous contract found, skipping breaking change check"
          fi

  backend-contract-test:
    name: Backend Contract Tests (SpecIT)
    runs-on: ubuntu-latest
    needs: validate-openapi
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Setup Python (for Schemathesis)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Schemathesis
        run: pip install schemathesis

      - name: Build Backend
        working-directory: backend
        run: mvn compile -DskipTests

      - name: Run Backend Unit Tests
        working-directory: backend
        run: mvn test -Dtest=*ApiIT -DfailIfNoTests=false

      - name: Validate Backend against OpenAPI Contract
        run: |
          echo "üîç Validating backend implementation against OpenAPI contract..."
          schemathesis run ${{ env.OPENAPI_SPEC }} \
            --dry-run \
            --validate-schema=true \
            --hypothesis-phases=explicit \
            || echo "‚ö†Ô∏è Schemathesis dry-run validation complete (server not running)"

  frontend-contract-validation:
    name: Frontend Contract Validation (SpecIT)
    runs-on: ubuntu-latest
    needs: validate-openapi
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm install

      - name: Generate TypeScript types from OpenAPI
        run: |
          echo "üîç Generating TypeScript types from OpenAPI contract..."
          npx openapi-typescript ${{ env.OPENAPI_SPEC }} -o frontend/src/services/generated-types.ts
          echo "‚úÖ Types generated successfully"

      - name: TypeScript type check
        working-directory: frontend
        run: |
          echo "üîç Running TypeScript type check..."
          npx tsc --noEmit
          echo "‚úÖ TypeScript validation passed"

      - name: Run frontend tests
        working-directory: frontend
        run: npm test -- --run

  notify-on-failure:
    name: Notify on Build Failure
    runs-on: ubuntu-latest
    needs: [validate-openapi, backend-contract-test, frontend-contract-validation]
    if: failure()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get failed job details
        id: failed-jobs
        run: |
          echo "workflow_name=${{ github.workflow }}" >> $GITHUB_OUTPUT
          echo "run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "actor=${{ github.actor }}" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Contract Validation Failed - ${context.sha.substring(0, 7)}`;
            const body = `## Contract Validation Failure

            **Workflow:** ${{ steps.failed-jobs.outputs.workflow_name }}
            **Branch:** ${{ steps.failed-jobs.outputs.branch }}
            **Commit:** ${{ steps.failed-jobs.outputs.commit_sha }}
            **Triggered by:** @${{ steps.failed-jobs.outputs.actor }}

            ### üîó Links
            - [View Workflow Run](${{ steps.failed-jobs.outputs.run_url }})
            - [View Commit](${context.payload.repository.html_url}/commit/${context.sha})

            ### üìã Possible Issues
            - OpenAPI contract validation failed (Spectral/Redocly)
            - Backend implementation doesn't match contract
            - Frontend types don't match contract
            - Breaking changes detected in API

            ### üîß Next Steps
            1. Check the workflow logs for specific errors
            2. Fix the contract or implementation mismatch
            3. Re-run the validation

            ---
            *This issue was automatically created by the Contract Validation workflow.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['contract-validation', 'automated', 'bug']
            });

      - name: Post to PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ‚ùå Contract Validation Failed

            The contract validation checks have failed. Please review the errors below:

            | Check | Status |
            |-------|--------|
            | OpenAPI Validation | ${{ needs.validate-openapi.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
            | Backend Contract Test | ${{ needs.backend-contract-test.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |
            | Frontend Contract Validation | ${{ needs.frontend-contract-validation.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |

            [View Full Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            *Please fix the issues before merging this PR.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
